package com.keylimetie.dottys.beacon_service

import android.content.Context
import android.util.Log
<<<<<<< HEAD
import com.estimote.sdk.Beacon
import com.estimote.sdk.BeaconManager
import com.estimote.sdk.Nearable
import com.estimote.sdk.Region
=======
import com.estimote.coresdk.observation.region.Region
import com.estimote.coresdk.observation.region.beacon.BeaconRegion
import com.estimote.coresdk.recognition.packets.Beacon
import com.estimote.coresdk.recognition.packets.Nearable
import com.estimote.coresdk.service.BeaconManager
import com.estimote.mgmtsdk.feature.settings.api.EstimotePackets

>>>>>>> new_develop
import com.keylimetie.dottys.DottysBaseActivity
import com.keylimetie.dottys.PreferenceTypeKey
import com.keylimetie.dottys.ui.dashboard.DashboardFragment
import com.keylimetie.dottys.ui.dashboard.models.DottysBeacon
import com.keylimetie.dottys.ui.dashboard.models.DottysBeaconArray
import java.util.*
import kotlin.properties.Delegates

open class DottysBeaconActivity(baseActivity:DottysBaseActivity)    {
  var observer: DottysBeaconActivityObserver? = null

  var baseActivity = baseActivity
  var beaconManager: BeaconManager? = null
  val beaconViewModel = DottysBeaconViewModel()

    fun initBeaconManager() {


    Log.d("BEACON ACTIVITY", "Beacon Service Started")
      baseActivity.sharedPreferences = baseActivity.getSharedPreferences(
          PreferenceTypeKey.USER_DATA.name,
          Context.MODE_PRIVATE
      )
     //currentBeacon =   baseActivity.getBeaconAtStoreLocation()


    if (baseActivity.getBeaconAtStoreLocation()?.size ?: 0 == 0) {
      Log.d("ERROR BEACON", "<<======== NULL BEACON ==============")
        val emptyStatus = DottysBeaconArray(baseActivity.getBeaconAtStoreLocation())
        baseActivity?.saveDataPreference(PreferenceTypeKey.BEACON_AT_CONECTION,emptyStatus.toJson())
        observer?.listOfBeacons = DottysBeaconArray(emptyStatus.beaconArray)
      return //START_REDELIVER_INTENT
    }

        beaconManager = BeaconManager(baseActivity)
        beaconManager?.connect {
            for (beacon in baseActivity.getBeaconAtStoreLocation()!!) {
                if(beacon.isConected != true) {
<<<<<<< HEAD
                    beaconManager?.startMonitoring(
                        Region(
                            beacon.id,
                            UUID.fromString(beacon.uuid),
                            beacon.major?.toInt(),
                            beacon.minor?.toInt()
                        )
                    )
=======
                    beaconManager?.startMonitoring(BeaconRegion(
                        beacon.id,
                        UUID.fromString(beacon.uuid),
                        beacon.major?.toInt(),
                        beacon.minor?.toInt()))
>>>>>>> new_develop
                }
            }

        }


        beaconManager?.setForegroundScanPeriod(5,30)
        beaconManager?.setBackgroundScanPeriod(5,30)
        startDiscoveringLisener()
        starMonitoringLisener()
  }


    fun startDiscoveringLisener(){
        beaconManager?.setNearableListener(object : BeaconManager.NearableListener {
<<<<<<< HEAD
            override fun onNearablesDiscovered(p0: MutableList<Nearable>?) {


                Log.d("BEACON ACTIVITY", "Has nearable a reagion ${p0?.first()?.region} beacons")
=======
           override fun onNearablesDiscovered(nearables: MutableList<Nearable>?) {
                Log.d("BEACON ACTIVITY", "Has nearable a reagion ${nearables?.first()?.identifier} beacons")
>>>>>>> new_develop
            }
        })
    }
    private fun starMonitoringLisener(){
<<<<<<< HEAD
        beaconManager?.setMonitoringListener(object : BeaconManager.MonitoringListener {


            override fun onEnteredRegion(region: Region, list: List<Beacon>) {
=======
        beaconManager?.setMonitoringListener(object : BeaconManager.BeaconMonitoringListener {


            override fun onEnteredRegion(
                beaconRegion: BeaconRegion?,
                beacons: MutableList<Beacon>?
            ) {
>>>>>>> new_develop
                var beaconList = DottysBeaconArray()
                when {
                    baseActivity.getBeaconStatus()?.beaconArray?.size ?: 0 > 0 -> {
                        beaconList =  DottysBeaconArray(baseActivity.getBeaconStatus()?.beaconArray ?: ArrayList<DottysBeacon>())
                    }
                    else -> beaconList =    DottysBeaconArray(baseActivity.getBeaconAtStoreLocation())
                }
<<<<<<< HEAD
               
                var currentBeacon = DottysBeacon()
                for (beacon in beaconList.beaconArray ?: baseActivity.getBeaconAtStoreLocation() ?: return) {
                    if (beacon.id == region.identifier){
=======

                var currentBeacon = DottysBeacon()
                for (beacon in beaconList.beaconArray ?: baseActivity.getBeaconAtStoreLocation() ?: return) {
                    if (beacon.id == beaconRegion?.identifier){
>>>>>>> new_develop
                        beacon.isConected = true
                        currentBeacon = beacon
                    }
                }
                Log.d("BEACON ACTIVITY ", "PROGRESS -- ${baseActivity.progressBar?.visibility.toString()}")
<<<<<<< HEAD
                Log.d("BEACON ACTIVITY ", "${region.identifier} <<======== ENTER ON BEACON ==============")
                if(baseActivity.progressBar?.visibility != 0) {
                    beaconViewModel.recordBeacon(
                        baseActivity, DottysBeaconRequestModel(
                            region.identifier,
                            region.proximityUUID.toString(),
                            region.major.toLong(),
                            region.minor.toLong(), BeaconEventType.ENTER.name
                        )
                    )
               //     observer?.listOfBeacons = DottysBeaconArray(beaconList.beaconArray)
                }

            }



            override fun onExitedRegion(region: Region) {
                var beaconList: DottysBeaconArray
                  when {
=======
                Log.d("BEACON ACTIVITY ", "${beaconRegion?.identifier} <<======== ENTER ON BEACON ==============")
                if(baseActivity.progressBar?.visibility != 0) {
                    beaconViewModel.recordBeacon(
                        baseActivity, DottysBeaconRequestModel(
                            beaconRegion?.identifier,
                            beaconRegion?.proximityUUID.toString(),
                            beaconRegion?.major?.toLong(),
                            beaconRegion?.minor?.toLong(), BeaconEventType.ENTER.name
                        )
                    )
                    //     observer?.listOfBeacons = DottysBeaconArray(beaconList.beaconArray)
                }
            }

            override fun onExitedRegion(beaconRegion: BeaconRegion?) {
                var beaconList: DottysBeaconArray
                when {
>>>>>>> new_develop
                    baseActivity.getBeaconStatus()?.beaconArray?.size ?: 0 > 0 -> {
                        beaconList =  DottysBeaconArray(baseActivity.getBeaconStatus()?.beaconArray ?: ArrayList<DottysBeacon>())
                    }
                    else -> beaconList =    DottysBeaconArray(baseActivity.getBeaconAtStoreLocation())
                }
                var currentBeacon = DottysBeacon()
                for (beacon in beaconList.beaconArray ?: return) {
<<<<<<< HEAD
                    if (beacon.id == region.identifier){
=======
                    if (beacon.id == beaconRegion?.identifier){
>>>>>>> new_develop
                        beacon.isConected = false
                        currentBeacon = beacon
                    }
                }
                Log.d("BEACON ACTIVITY ", "PROGRESS -- ${baseActivity.progressBar?.visibility.toString()}")
<<<<<<< HEAD
                Log.d("BEACON ACTIVITY ", "${region.identifier} <<======== EXIT ON BEACON ==============")
                if(baseActivity.progressBar?.visibility != 0) {
                    beaconViewModel.recordBeacon(
                        baseActivity, DottysBeaconRequestModel(
                            region.identifier,
                            region.proximityUUID.toString(),
                            region.major.toLong(),
                            region.minor.toLong(), BeaconEventType.EXIT.name
                        )
                    )
               //     observer?.listOfBeacons = DottysBeaconArray(beaconList.beaconArray)
=======
                Log.d("BEACON ACTIVITY ", "${beaconRegion?.identifier} <<======== EXIT ON BEACON ==============")
                if(baseActivity.progressBar?.visibility != 0) {
                    beaconViewModel.recordBeacon(
                        baseActivity, DottysBeaconRequestModel(
                            beaconRegion?.identifier,
                            beaconRegion?.proximityUUID.toString(),
                            beaconRegion?.major?.toLong(),
                            beaconRegion?.minor?.toLong(), BeaconEventType.EXIT.name
                        )
                    )
                    //     observer?.listOfBeacons = DottysBeaconArray(beaconList.beaconArray)
>>>>>>> new_develop
                }
            }
        })
    }

    fun destroy() {
     Log.d("DESTROY ", "Beacon Service Destroyed")
   // disposable.dispose()
    beaconManager?.disconnect()
  }
}

interface DottysBeaconActivityDelegate {
    fun onBeaconsServiceChange(beaconsData: DottysBeaconArray)
}

class DottysBeaconActivityObserver(listeners: DottysBeaconActivityDelegate) {
    var listOfBeacons: DottysBeaconArray by Delegates.observable(
        initialValue = DottysBeaconArray(),
        onChange = { _, _, new -> listeners.onBeaconsServiceChange(new)})
}